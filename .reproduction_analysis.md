# Analyse: ProblÃ¨me de Calcul de ConsanguinitÃ©

**Date:** 1er janvier 2026  
**ProblÃ¨me:** Tous les scores de simulation affichent ~100, coefficient de consanguinitÃ© toujours Ã  0%

---

## Diagnostic

### âœ… Le Code est Correct

L'algorithme de calcul de consanguinitÃ© (`calculateInbreedingCoefficient`) dans `utils/genetics.ts` est **correctement implÃ©mentÃ©** selon la mÃ©thode de Wright:

1. **Trouve les ancÃªtres communs** entre le pÃ¨re et la mÃ¨re
2. **Calcule les chemins** du pÃ¨re â†’ ancÃªtre et mÃ¨re â†’ ancÃªtre  
3. **Applique la formule de Wright:** COI = Î£ (0.5)^n pour tous les chemins valides
4. **Filtre les doublons** pour Ã©viter de compter deux fois le mÃªme chemin

### âŒ Le ProblÃ¨me: DonnÃ©es Manquantes

**Le calcul retourne toujours 0 parce que les animaux n'ont pas leurs informations de pedigree.**

Dans `Animal` type:
```typescript
sireId?: string;  // ID du pÃ¨re (optionnel)
damId?: string;   // ID de la mÃ¨re (optionnel)
```

**Sans ces donnÃ©es:**
- `findCommonAncestors()` retourne un tableau vide
- Le coefficient est 0
- Le score reste proche de 100 (pas de pÃ©nalitÃ©)

---

## VÃ©rification

### Code dans MatrixBreedingSimulator.tsx (ligne 47-55):

```typescript
const inbreedingCoefficient = calculateInbreedingCoefficient(sire.id, dam.id, animals);
const inbreedingPenalty = inbreedingCoefficient * 50;
const overallScore = Math.round(
    (morphometricScore * 0.6) + ((100 - inbreedingPenalty) * 0.4)
);
```

**Si inbreedingCoefficient = 0:**
- inbreedingPenalty = 0 * 50 = 0
- overallScore = morphometricScore * 0.6 + 100 * 0.4
- overallScore = morphometricScore * 0.6 + 40

**Donc le score minimum est 40**, et si morphometricScore = 100, alors overallScore = 100.

---

## Solutions

### Solution 1: Ajouter les Pedigrees Manuellement (RecommandÃ© ImmÃ©diatement)

**Ã‰tapes:**
1. Ouvrir la modal "Ajouter/Modifier un Animal"
2. Dans la section "PÃ©digrÃ©", remplir:
   - **PÃ¨re (Sire):** SÃ©lectionner le mÃ¢le parent
   - **MÃ¨re (Dam):** SÃ©lectionner la femelle parent
3. Sauvegarder

**Avantages:**
- âœ… Solution immÃ©diate
- âœ… ContrÃ´le total sur les donnÃ©es
- âœ… PrÃ©cision garantie

**InconvÃ©nients:**
- âš ï¸ Manuel et fastidieux pour un grand troupeau
- âš ï¸ NÃ©cessite de connaÃ®tre tous les pedigrees

### Solution 2: Import en Masse via CSV/Excel

**CrÃ©er un script d'import permettant de:**
1. TÃ©lÃ©charger un template CSV avec colonnes:
   - `tagId`, `name`, `sireTagId`, `damTagId`
2. Remplir le fichier avec les pedigrees connus
3. Importer en masse

**Avantages:**
- âœ… Rapide pour beaucoup d'animaux
- âœ… Peut Ãªtre prÃ©parÃ© hors ligne

**InconvÃ©nients:**
- âš ï¸ NÃ©cessite dÃ©veloppement supplÃ©mentaire
- âš ï¸ Risque d'erreurs de saisie

### Solution 3: GÃ©nÃ©ration de DonnÃ©es de Test RÃ©alistes

**Pour tester la fonctionnalitÃ©**, crÃ©er un script qui:
1. GÃ©nÃ¨re une hiÃ©rarchie d'animaux avec pedigrees complets
2. CrÃ©e des scÃ©narios de consanguinitÃ© variÃ©s:
   - Animaux non apparentÃ©s (COI = 0%)
   - Cousins au 1er degrÃ© (COI = 6.25%)
   - Demi-frÃ¨re/sÅ“ur (COI = 12.5%)
   - FrÃ¨re/sÅ“ur (COI = 25%)

**Avantages:**
- âœ… Permet de valider l'algorithme
- âœ… DÃ©mo convaincante pour les utilisateurs
- âœ… Tests automatisÃ©s possibles

**InconvÃ©nients:**
- âš ï¸ DonnÃ©es fictives, pas pour la production
- âš ï¸ NÃ©cessite script de gÃ©nÃ©ration

### Solution 4: AmÃ©liorer l'UX pour Signaler les DonnÃ©es Manquantes

**Dans l'interface de simulation**, ajouter:

```typescript
// VÃ©rifier si les animaux ont des pedigrees
const animalsWithPedigree = animals.filter(a => a.sireId || a.damId);
const pedigreeCompleteness = (animalsWithPedigree.length / animals.length) * 100;

// Afficher un avertissement si < 50%
if (pedigreeCompleteness < 50) {
    return (
        <Alert variant="warning">
            <AlertTriangle />
            <p>
                <strong>Pedigrees incomplets:</strong> {pedigreeCompleteness.toFixed(0)}% 
                de votre troupeau a des informations de pedigree.
            </p>
            <p>
                Pour des calculs de consanguinitÃ© prÃ©cis, veuillez renseigner 
                les parents (pÃ¨re/mÃ¨re) de chaque animal dans leur fiche.
            </p>
        </Alert>
    );
}
```

**Avantages:**
- âœ… Guide l'utilisateur
- âœ… Explique pourquoi les scores sont tous Ã  100
- âœ… Encourage la saisie complÃ¨te

---

## Exemple de Calcul avec DonnÃ©es RÃ©elles

### ScÃ©nario 1: Animaux Non ApparentÃ©s
```
PÃ¨re: Alpha (pas de parents connus)
MÃ¨re: Beta (pas de parents connus)
â†’ AncÃªtres communs: Aucun
â†’ COI = 0%
â†’ Risque: Low
â†’ Score: ~95-100 (selon morphomÃ©trie)
```

### ScÃ©nario 2: Cousins au 1er DegrÃ©
```
PÃ¨re: Charlie (fils de Alpha Ã— Delta)
MÃ¨re: Diana (fille de Beta Ã— Delta)
â†’ AncÃªtre commun: Delta (grand-mÃ¨re commune)
â†’ Chemin: Charlie â†’ Delta â† Diana
â†’ COI = (0.5)^3 = 12.5% (arrondi Ã  0.125)
â†’ Risque: Medium
â†’ PÃ©nalitÃ©: 12.5 * 50 = 6.25 points
â†’ Score: 85-90
```

### ScÃ©nario 3: Demi-FrÃ¨re/SÅ“ur
```
PÃ¨re: Echo (fils de Alpha Ã— Femelle1)
MÃ¨re: Foxtrot (fille de Alpha Ã— Femelle2)
â†’ AncÃªtre commun: Alpha (pÃ¨re commun)
â†’ COI = (0.5)^3 = 12.5%
â†’ Risque: Medium  
â†’ Score: 80-85
```

### ScÃ©nario 4: FrÃ¨re/SÅ“ur Complet
```
PÃ¨re: Golf (fils de Alpha Ã— Beta)
MÃ¨re: Hotel (fille de Alpha Ã— Beta)
â†’ AncÃªtres communs: Alpha ET Beta
â†’ COI = 2 Ã— (0.5)^3 = 25%
â†’ Risque: High
â†’ PÃ©nalitÃ©: 25 * 50 = 12.5 points
â†’ Score: 70-75
â†’ Recommandation: NotRecommended (rouge)
```

---

## Actions RecommandÃ©es

### ImmÃ©diat:
1. âœ… **Ajouter un message d'avertissement** dans l'UI de simulation si < 50% des animaux ont un pedigree
2. âœ… **CrÃ©er un guide utilisateur** expliquant comment renseigner les pedigrees
3. âœ… **Documenter** la formule de calcul dans l'interface (tooltip)

### Court Terme:
1. ğŸ”² **Remplir manuellement** les pedigrees pour 10-20 animaux clÃ©s
2. ğŸ”² **Tester** qu simulation avec ces donnÃ©es rÃ©elles
3. ğŸ”² **Valider** que les scores varient correctement

### Moyen Terme:
1. ğŸ”² **DÃ©velopper l'import CSV** pour pedigrees en masse
2. ğŸ”² **CrÃ©er un script de gÃ©nÃ©ration** de donnÃ©es de test rÃ©aliste
3. ğŸ”² **Ajouter des statistiques** sur la complÃ©tude des pedigrees dans le Dashboard

### Long Terme:
1. ğŸ”² **IntÃ©gration avec registres externes** (si applicable pour Ladoum)
2. ğŸ”² **Validation automatique** des pedigrees (dÃ©tection d'incohÃ©rences)
3. ğŸ”² **Visualisation graphique** de l'arbre gÃ©nÃ©alogique du troupeau

---

## Conclusion

**Le calcul de consanguinitÃ© fonctionne parfaitement.** Le problÃ¨me vient uniquement du manque de donnÃ©es de pedigree dans la base de donnÃ©es.

**Solutions immÃ©diates:**
1. Ajouter un message clair dans l'UI
2. Renseigner les pedigrees manuellement pour quelques animaux
3. Tester et valider le calcul

**Le code n'a pas besoin d'Ãªtre modifiÃ©**, seulement les donnÃ©es doivent Ãªtre complÃ©tÃ©es.

---

*DerniÃ¨re mise Ã  jour: 1er janvier 2026, 11:34*
