# Pedigree V1 ‚Äî Sprint 3: Canvas Integration

**Date:** 1er janvier 2026, 17:10  
**Status:** ‚úÖ TERMIN√â  
**Dur√©e:** ~20 minutes

---

## üéØ OBJECTIFS SPRINT 3

Int√©grer toute la logique V1 dans des composants React fonctionnels:
1. ‚úÖ Cr√©er `PedigreeViewer.tsx` (orchestrateur)
2. ‚úÖ Cr√©er `PedigreeCanvas.tsx` (moteur de rendu)
3. ‚úÖ Adapter `PedigreeNode.tsx` (highlight visuel)
4. ‚úÖ Int√©grer s√©lection + highlight

---

## üì¶ LIVRABLES

### 1. `PedigreeViewer.tsx` (Orchestrateur)

**Responsabilit√©s:**
- Charger tous les animaux
- G√©rer √©tat s√©lection (hook)
- Construire graphe pedigree
- Calculer anc√™tres communs
- Calculer n≈ìuds visibles
- Computer layout
- Passer tout au Canvas

**Code Structure:**
```tsx
export const PedigreeViewer = () => {
  // Data
  const { animals } = useAnimals();
  
  // Selection
  const { selection, selectOne, toggleSelection, clearSelection } = 
    usePedigreeSelection();
  
  // Graph analysis
  const graph = buildPedigreeGraph(animals);
  const commonAncestors = findCommonAncestors([...selection], graph);
  const visibleNodes = getVisibleNodes(selection, graph);
  
  // Layout
  const layout = computeMultiRootLayout(selection, animals, 5);
  
  // Handlers
  const handleNodeClick = (id, ctrlKey) => {
    ctrlKey ? toggleSelection(id) : selectOne(id);
  };
  
  return (
    <>
      <SelectionControls {...} />
      <PedigreeCanvas
        layout={layout}
        selection={selection}
        commonAncestors={commonAncestors}
        visibleNodes={visibleNodes}
        onNodeClick={handleNodeClick}
      />
    </>
  );
};
```

**Props pass√©es √† Canvas:**
- `layout`: R√©sultat du layout multi-root
- `selection`: Set d'IDs s√©lectionn√©s
- `commonAncestors`: Set d'anc√™tres communs
- `visibleNodes`: Set de n≈ìuds visibles
- `onNodeClick`: Handler clic (simple/Ctrl)

---

### 2. `PedigreeCanvas.tsx` (Moteur de Rendu)

**Responsabilit√©s:**
- Rendu SVG pure
- Zoom/pan (hook)
- Appliquer opacit√©s selon highlight
- G√©rer clics utilisateur
- Afficher barres haut/bas

**Structure:**
```tsx
export const PedigreeCanvas = ({
  layout,
  selection,
  commonAncestors,
  visibleNodes,
  onNodeClick
}) => {
  // Zoom/Pan
  const { transform, handlers, reset, fitToView, zoomIn, zoomOut } = 
    useZoomPan(svgRef);
  
  // Edges highlight
  const highlightedEdges = getHighlightedEdges(selection, visibleNodes);
  
  return (
    <div className="flex flex-col">
      {/* Top Bar: Mode + Zoom controls */}
      <div className="h-16 bg-white border-b">
        <span>{selectionMode} mode</span>
        <ZoomControls {...} />
      </div>
      
      {/* SVG Canvas */}
      <svg {...handlers}>
        <g transform={`translate(...) scale(...)`}>
          {/* Edges avec opacit√©s */}
          {edges.map(edge => (
            <path 
              opacity={getEdgeOpacity(...)}
              className="transition-opacity"
            />
          ))}
          
          {/* Nodes avec opacit√©s */}
          {nodes.map(node => (
            <g 
              opacity={getNodeOpacity(...)}
              onClick={(e) => onNodeClick(node.id, e.ctrlKey)}
            >
              <PedigreeNode
                node={node}
                isSelected={selection.has(node.id)}
                isCommonAncestor={commonAncestors.has(node.id)}
              />
            </g>
          ))}
        </g>
      </svg>
      
      {/* Bottom Bar: Legend */}
      <div className="h-14 bg-white border-t">
        <Legend />
        <Help text="Clic ‚Üí Select ‚Ä¢ Ctrl+Clic ‚Üí Multi" />
      </div>
    </div>
  );
};
```

**Highlight Logic:**
```typescript
// Pour chaque edge
const opacity = getEdgeOpacity(
  edge.from,
  edge.to,
  selection,
  highlightedEdges,
  visibleNodes
);

// Pour chaque node
const opacity = getNodeOpacity(
  node.id,
  selection,
  commonAncestors,
  visibleNodes
);
```

---

### 3. `PedigreeNode.tsx` (Updated)

**Nouveaux props:**
```typescript
interface PedigreeNodeProps {
  node: LayoutNode;
  isSelected?: boolean;           // NEW
  isCommonAncestor?: boolean;     // NEW
  onClick?: (node) => void;
  onAddFather?: (node) => void;  // Legacy (gard√© pour compat)
  onAddMother?: (node) => void;  // Legacy
}
```

**Logique highlight:**
```typescript
// Base colors
let borderColor = sex === 'M' ? '#60A5FA' : '#F472B6';
let strokeWidth = 2;

// Override pour s√©lection
if (isSelected) {
  borderColor = '#1E40AF'; // Bleu fonc√©
  strokeWidth = 4;         // Plus √©pais
} else if (isCommonAncestor) {
  borderColor = '#F59E0B'; // Amber
  strokeWidth = 3;
}

<rect
  stroke={borderColor}
  strokeWidth={strokeWidth}
  className="transition-all duration-300"
/>
```

---

## üé® EXP√âRIENCE UTILISATEUR

### Vue Globale (0 s√©lection)

**Affichage:**
- Tous les animaux du troupeau
- Opacit√© √©gale partout (0.8)
- Pas de highlight particulier

**Top Bar:**
```
Vue globale                      85%  [Fit All]  [Reset]
```

---

### Vue Individuelle (1 s√©lection)

**Affichage:**
- Animal s√©lectionn√©: border bleu fonc√© (4px), opacity 1.0
- Parents/enfants directs: opacity 0.9
- Anc√™tres/descendants: opacity 0.6
- Hors scope: opacity 0.3

**SelectionControls:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üë§ S√©lection  [√ó]  ‚îÇ
‚îÇ ‚Ä¢ Dieureuf         ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
‚îÇ Clic ‚Üí Unique      ‚îÇ
‚îÇ Ctrl+Clic ‚Üí Multi  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Top Bar:**
```
Vue individuelle                 85%  [Fit All]  [Reset]
```

---

### Vue Group√©e (N s√©lection)

**Affichage:**
- Animaux s√©lectionn√©s: border bleu fonc√© (4px), opacity 1.0
- Anc√™tres communs: border amber (3px), opacity 1.0
- Visible mais pas select: opacity 0.6
- Hors scope: opacity 0.3

**SelectionControls:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üë• 5 animaux s√©lectionn√©s [√ó] ‚îÇ
‚îÇ ‚Ä¢ Animal A              ‚îÇ
‚îÇ ‚Ä¢ Animal B              ‚îÇ
‚îÇ ‚Ä¢ Animal C              ‚îÇ
‚îÇ + 2 autres              ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
‚îÇ üîó 2 anc√™tres communs   ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
‚îÇ Clic ‚Üí Unique           ‚îÇ
‚îÇ Ctrl+Clic ‚Üí Multi       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Bottom Bar (l√©gende):**
```
üîµ M√¢le  üî¥ Femelle  üü° Anc√™tre commun    Clic ‚Üí Select ‚Ä¢ Ctrl+Clic ‚Üí Multi
```

**Top Bar:**
```
Vue group√©e (5)                  85%  [Fit All]  [Reset]
```

---

## üîÑ FLUX D'INTERACTION

### Sc√©nario 1: S√©lection simple

```
1. User: Clic sur "Animal A"
   ‚Üì
2. onNodeClick(A, ctrlKey=false)
   ‚Üì
3. selectOne(A)
   ‚Üì
4. selection = Set([A])
   ‚Üì
5. Re-render avec highlight
```

### Sc√©nario 2: Multi-s√©lection

```
1. User: Ctrl+Clic sur "Animal B"
   ‚Üì
2. onNodeClick(B, ctrlKey=true)
   ‚Üì
3. toggleSelection(B)
   ‚Üì
4. selection = Set([A, B])
   ‚Üì
5. Calcul anc√™tres communs
   ‚Üì
6. Re-render avec 2 s√©lectionn√©s + anc√™tres en amber
```

### Sc√©nario 3: D√©s√©lectionner

```
1. User: Clic bouton [√ó] dans SelectionControls
   ‚Üì
2. clearSelection()
   ‚Üì
3. selection = Set([])
   ‚Üì
4. Re-render vue globale
```

---

## üìä PERFORMANCES

**useMemo sur calculs co√ªteux:**

```typescript
// Graph (recalcul si animals change)
const graph = useMemo(
  () => buildPedigreeGraph(animals),
  [animals]
);

// Common ancestors (recalcul si selection change)
const commonAncestors = useMemo(
  () => findCommonAncestors([...selection], graph),
  [selection, graph]
);

// Layout (recalcul si selection ou animals change)
const layout = useMemo(
  () => computeMultiRootLayout(selection, animals, 5),
  [selection, animals]
);
```

**Temps de rendu estim√©:**
- 100 animaux: < 50ms
- 1000 animaux: < 200ms

---

## üéØ R√àGLES PRD IMPL√âMENT√âES

‚úÖ **"Un seul moteur de rendu"**  
‚Üí `PedigreeCanvas` unique pour toutes les vues

‚úÖ **"La s√©lection est le seul mode de navigation"**  
‚Üí Clic/Ctrl+Clic change s√©lection ‚Üí change vue auto

‚úÖ **"Toute s√©lection ram√®ne √† lecture intelligible"**  
‚Üí Opacit√©s + highlight rendent toujours clair

‚úÖ **"Zoom/pan/fit"**  
‚Üí Contr√¥les int√©gr√©s + molette souris

‚úÖ **"Lecture seule V1"**  
‚Üí Pas de boutons "+" (comment√©s/d√©sactiv√©s)

---

## üöÄ PROCHAINES √âTAPES

### Sprint 4: Int√©gration dans App

**Objectifs:**
1. Cr√©er route `/pedigree` (vue globale)
2. Remplacer route `/pedigree/:id` par `PedigreeViewer`
3. Tester dans navigateur
4. Ajustements UX

**Fichiers √† modifier:**
- `App.tsx` ou router
- Supprimer/backup ancienne `FamilyTree.tsx`

---

## ‚úÖ VALIDATION

- [x] Code compil√© sans erreurs
- [x] Imports corrects
- [x] Props typ√©es
- [x] Transitions CSS ajout√©es
- [ ] Tests navigateur (TODO Sprint 4)
- [ ] Tests utilisateur (TODO Sprint 5)

---

*Sprint 3 termin√©! Le syst√®me de rendu avec s√©lection est op√©rationnel.*
