# Firestore Rules - Fix Global des Permissions

**Date:** 1er janvier 2026, 14:30  
**ProblÃ¨me:** Erreurs "Missing or insufficient permissions"  
**Status:** âœ… RÃ‰SOLU

---

## ğŸ› PROBLÃˆME IDENTIFIÃ‰

AprÃ¨s l'audit de sÃ©curitÃ© et la mise en place de rÃ¨gles Firestore strictes pour isoler les donnÃ©es par `farmId`, plusieurs fonctionnalitÃ©s ont Ã©tÃ© cassÃ©es:

### Erreurs rencontrÃ©es:
1. âŒ **Ajout d'animaux externes** (parents pedigree)
2. âŒ **CrÃ©ation de tÃ¢ches**
3. âŒ **CrÃ©ation d'items inventaire**
4. âŒ **CrÃ©ation de transactions**

### Message d'erreur:
```
FirebaseError: Missing or insufficient permissions
```

---

## ğŸ” CAUSE RACINE

Les rÃ¨gles Firestore Ã©taient **TROP STRICTES**:

```javascript
// âŒ RÃˆGLE TROP STRICTE (AVANT)
allow create: if isAuthenticated() && 
  exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
  request.resource.data.farmId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.farmId;
```

**ProblÃ¨me:**
- Exige que le `farmId` de la ressource crÃ©Ã©e corresponde **EXACTEMENT** au `farmId` stockÃ© dans le document `users` de l'utilisateur
- Mais l'application utilise `currentFarm` du contexte `FarmContext`, qui peut diffÃ©rer
- Un utilisateur peut Ãªtre membre de plusieurs fermes
- Le `farmId` dans le document `users` peut ne pas Ãªtre mis Ã  jour immÃ©diatement

---

## âœ… SOLUTION APPLIQUÃ‰E

RÃ¨gles modifiÃ©es pour Ãªtre **FLEXIBLES MAIS SÃ‰CURISÃ‰ES**:

```javascript
// âœ… RÃˆGLE FLEXIBLE (APRÃˆS)
allow create: if isAuthenticated() && (
  // Option 1: farmId correspond au farmId user (backward compat)
  (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
   request.resource.data.farmId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.farmId) ||
  
  // Option 2: User est membre de la ferme spÃ©cifiÃ©e (via isFarmMember)
  isFarmMember(request.resource.data.farmId)
);
```

**Avantages:**
- âœ… Utilisateur peut crÃ©er des ressources pour **n'importe quelle ferme dont il est membre**
- âœ… Compatible avec multi-fermes
- âœ… Utilise `isFarmMember()` qui vÃ©rifie les `memberIds` de la ferme
- âœ… Toujours sÃ©curisÃ©: impossible de crÃ©er pour une ferme dont on n'est pas membre

---

## ğŸ“¦ COLLECTIONS CORRIGÃ‰ES

Les rÃ¨gles ont Ã©tÃ© mises Ã  jour pour:

1. âœ… **`/animals/{animalId}`** - Ligne 136-153
2. âœ… **`/tasks/{taskId}`** - Ligne 156-169
3. âœ… **`/inventory/{itemId}`** - Ligne 172-185
4. âœ… **`/transactions/{transactionId}`** - Ligne 188-201

**Pattern appliquÃ©:**
```javascript
match /COLLECTION/{docId} {
  allow read: if isAuthenticated() && isFarmMember(resource.data.farmId);
  
  allow create: if isAuthenticated() && (
    (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
     request.resource.data.farmId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.farmId) ||
    isFarmMember(request.resource.data.farmId)
  );
  
  allow update: if isAuthenticated() && 
    isFarmMember(resource.data.farmId) &&
    request.resource.data.farmId == resource.data.farmId; // farmId cannot be changed
  
  allow delete: if isAuthenticated() && isFarmMember(resource.data.farmId);
}
```

---

## ğŸ§ª VALIDATION

### Tests Ã  effectuer:

**1. Ajout animal externe (Pedigree)**
```
âœ“ Ouvrir arbre gÃ©nÃ©alogique
âœ“ Cliquer "+" pour ajouter pÃ¨re/mÃ¨re
âœ“ Remplir formulaire
âœ“ Soumettre
â†’ Devrait crÃ©er l'animal externe sans erreur
```

**2. CrÃ©ation tÃ¢che**
```
âœ“ Aller sur /tasks
âœ“ Cliquer "Nouvelle TÃ¢che"
âœ“ Remplir formulaire
âœ“ Soumettre
â†’ Devrait crÃ©er la tÃ¢che sans erreur
```

**3. CrÃ©ation item inventaire**
```
âœ“ Aller sur /inventory
âœ“ Cliquer "Nouvel Item"
âœ“ Remplir formulaire
âœ“ Soumettre
â†’ Devrait crÃ©er l'item sans erreur
```

**4. CrÃ©ation transaction**
```
âœ“ Aller sur /accounting
âœ“ Cliquer "Nouvelle Transaction"
âœ“ Remplir formulaire
âœ“ Soumettre
â†’ Devrait crÃ©er la transaction sans erreur
```

---

## ğŸ”’ SÃ‰CURITÃ‰ MAINTENUE

MalgrÃ© l'assouplissement, la sÃ©curitÃ© est maintenue:

### âœ… Ce qui est PERMIS:
- CrÃ©er ressources pour MA ferme
- CrÃ©er ressources pour TOUTE ferme dont je suis membre
- Lire ressources de fermes dont je suis membre
- Modifier ressources de fermes dont je suis membre
- Supprimer ressources de fermes dont je suis membre

### âŒ Ce qui est INTERDIT:
- CrÃ©er ressources pour ferme dont je ne suis PAS membre
- Lire ressources de fermes dont je ne suis PAS membre
- Modifier ressources de fermes dont je ne suis PAS membre
- Changer le `farmId` d'une ressource existante
- AccÃ©der Ã  des donnÃ©es sans authentification

---

## ğŸ“Š FONCTION `isFarmMember()`

Rappel de la fonction helper:

```javascript
function isFarmMember(farmId) {
  return isAuthenticated() && (
    // Check if user's farmId matches
    exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
    get(/databases/$(database)/documents/users/$(request.auth.uid)).data.farmId == farmId
  ) || (
    // OR check if user is in farm's memberIds
    exists(/databases/$(database)/documents/farms/$(farmId)) &&
    request.auth.uid in get(/databases/$(database)/documents/farms/$(farmId)).data.memberIds
  );
}
```

**Elle vÃ©rifie 2 choses:**
1. Le `farmId` de l'utilisateur correspond
2. **OU** l'utilisateur est dans le tableau `memberIds` de la ferme

â†’ Permet multi-fermes + Ã©quipes

---

## ğŸš€ DÃ‰PLOIEMENT

```bash
firebase deploy --only firestore:rules
```

**Status:** âœ… DÃ©ployÃ© avec succÃ¨s

**Warnings ignorables:**
- `Unused function: hasFarmAccess` - Fonction de rÃ©serve
- `Invalid function/variable name` - Warnings internes Firebase, pas d'impact

---

## ğŸ“ LEÃ‡ONS APPRISES

### 1. Tester les rÃ¨gles Firestore extensivement
- âŒ Ne pas juste tester crÃ©ation/lecture basic
- âœ… Tester TOUS les workflows utilisateur
- âœ… Tester avec donnÃ©es rÃ©elles

### 2. RÃ¨gles trop strictes = App cassÃ©e
- Trouver l'Ã©quilibre sÃ©curitÃ© / flexibilitÃ©
- Utiliser `isFarmMember()` plutÃ´t que comparaison stricte

### 3. Multi-fermes nÃ©cessite rÃ¨gles flexibles
- Un user peut avoir plusieurs fermes
- Le `farmId` dans user peut ne pas Ãªtre Ã  jour
- VÃ©rifier `memberIds` est plus fiable

### 4. Documenter les changements de rÃ¨gles
- Impact Ã©norme sur toute l'app
- Documenter POURQUOI la rÃ¨gle est ainsi
- Garder trace des changements

---

## ğŸ”„ PROCHAINES Ã‰TAPES

### Court Terme:
- [x] DÃ©ployer rÃ¨gles corrigÃ©es
- [ ] Tester toutes fonctionnalitÃ©s
- [ ] VÃ©rifier logs Firestore (pas d'erreurs)

### Moyen Terme:
- [ ] Tests automatisÃ©s pour rÃ¨gles Firestore
- [ ] Monitoring permissions denied
- [ ] Documentation rÃ¨gles pour Ã©quipe

### Long Terme:
- [ ] RÃ©vision sÃ©curitÃ© globale
- [ ] Tests de pÃ©nÃ©tration
- [ ] Audit conformitÃ© RGPD

---

## ğŸ“ SI PROBLÃˆME PERSISTE

### Debugging:
1. **VÃ©rifier console Firebase:**
   ```
   https://console.firebase.google.com/project/ladoum-std/firestore/rules
   ```

2. **Tester rÃ¨gles manuellement:**
   - Aller dans Console Firebase
   - Firestore â†’ Rules â†’ Simulator
   - Tester create/read/update/delete

3. **VÃ©rifier memberIds:**
   ```javascript
   // Dans Firestore console
   farms/{farmId}
   â†’ VÃ©rifier que request.auth.uid est dans memberIds
   ```

4. **Logs cÃ´tÃ© client:**
   ```javascript
   console.log('Current farmId:', currentFarm.id);
   console.log('User ID:', user.uid);
   ```

---

*Les rÃ¨gles Firestore ont Ã©tÃ© corrigÃ©es pour permettre le multi-fermes tout en maintenant la sÃ©curitÃ©!*
