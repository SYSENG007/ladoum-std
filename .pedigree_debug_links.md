# Debug: Liens de Filiation Incorrects

**Problème:** Les liens dans la vue globale connectent des animaux qui ne devraient pas être liés.

## Diagnostic

### Ce qui devrait se passer:

```typescript
// Dans computeLayout (lignes 62-86)
nodes.forEach(childNode => {
    // Edge from father to child
    if (childNode.fatherId) {
        const fatherNode = nodeMap.get(childNode.fatherId);
        if (fatherNode) {
            edges.push({ from: fatherNode.id, to: childNode.id });
        }
    }
    
    // Edge from mother to child
    if (childNode.motherId) {
        const motherNode = nodeMap.get(childNode.motherId);
        if (motherNode) {
            edges.push({ from: motherNode.id, to: childNode.id });
        }
    }
});
```

**Logique:** Edges créés UNIQUEMENT si:
1. Child a un `fatherId` ou `motherId`
2. Le parent correspondant existe dans `nodeMap`

## Hypothèses

### Hypothèse 1: Tous les animaux sont visibles
Si `selection.size === 0`, alors:
- `visibleIds = getVisibleNodes(new Set(), graph, 5, true)`
- Retourne TOUS les animaux (voir pedigreeGraph.ts ligne ~140)
- Donc tous visibles ✅

### Hypothèse 2: Génération mal calculée
Les animaux sont peut-être mal positionnés en générations, créant des liens visuels bizarres même s'ils sont corrects logiquement.

**Test:**
```
Animal A (root, gen 0)
  ↓
Animal B (enfant de A, gen -1)
  ↓
Animal C (enfant de B, gen -2)
```

Si Animal D (non lié) est mis en gen -1, il apparaît à côté de B mais sans lien.

## Solution Proposée

**Ajouter du logging temporaire:**

```typescript
// Dans computeLayout, après génération des edges
console.log('Generated edges:', edges.map(e => `${e.from} → ${e.to}`));
console.log('Nodes:', nodes.map(n => `${n.id} (gen ${n.generation})`));
```

Ou créer une fonction de validation:

```typescript
function validateEdges(edges: LayoutEdge[], nodes: LayoutNode[]): void {
    const nodeIds = new Set(nodes.map(n => n.id));
    
    edges.forEach(edge => {
        if (!nodeIds.has(edge.from)) {
            console.warn(`Edge from ${edge.from} references missing node`);
        }
        if (!nodeIds.has(edge.to)) {
            console.warn(`Edge to ${edge.to} references missing node`);
        }
    });
}
```

## Action Immédiate

Vérifier dans le navigateur (Console DevTools):
1. Nombre d'animaux chargés
2. Nombre de nodes rendus
3. Nombre d'edges rendus
4. Edges affichés VS edges attendus

**Commande Console:**
```javascript
// Dans la console du navigateur
const animals = window.__animals__ || [];  // Si exposé
console.log('Animals:', animals.length);
console.log('With sireId:', animals.filter(a => a.sireId).length);
console.log('With damId:', animals.filter(a => a.damId).length);
```

## Questions pour l'utilisateur

1. **Combien d'animaux** voyez-vous dans la vue globale?
2. **Combien de liens** (lignes) voyez-vous?
3. **Exemple de lien incorrect:** Pouvez-vous identifier 2 animaux connectés qui ne devraient PAS l'être?
4. **Lien manquant:** Y a-t-il des animaux qui DEVRAIENT être reliés mais ne le sont pas?

Cela nous aidera à comprendre si le problème est:
- Too many edges (liens en trop)
- Missing edges (liens manquants)
- Wrong positioning (animaux mal placés)
