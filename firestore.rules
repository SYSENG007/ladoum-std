rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the owner
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Helper function to check if user has access to farm
    function hasFarmAccess(farmId) {
      return isAuthenticated() && (
        // User is owner
        get(/databases/$(database)/documents/farms/$(farmId)).data.ownerId == request.auth.uid ||
        // User is member
        request.auth.uid in get(/databases/$(database)/documents/farms/$(farmId)).data.memberIds
      );
    }
    
    // Helper function to check if user is member of the farm that owns a resource
    function isFarmMember(farmId) {
      return isAuthenticated() && (
        // Check if user's farmId matches
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.farmId == farmId
      ) || (
        // OR check if user is in farm's memberIds
        exists(/databases/$(database)/documents/farms/$(farmId)) &&
        request.auth.uid in get(/databases/$(database)/documents/farms/$(farmId)).data.memberIds
      );
    }
    
    // User profiles
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      allow update, delete: if isOwner(userId);
    }
    
    // Helper function to check if user has a valid pending invitation for a farm
    function hasValidInvitation(farmId) {
      return exists(/databases/$(database)/documents/invitations/$(request.auth.uid + '_' + farmId)) ||
             // Fallback: check if any invitation exists for this user and farm
             exists(/databases/$(database)/documents/invitations/$(farmId + '_' + request.auth.uid));
    }
    
    // Farms
    match /farms/{farmId} {
      // Read access: must be in memberIds array
      allow read: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        request.auth.uid in resource.data.memberIds
      );
      
      // Create: any authenticated user can create a farm
      allow create: if isAuthenticated();
      
      // Update: 
      // 1. Owner can update anything, OR
      // 2. User can add themselves to memberIds ONLY (when accepting invitation)
      allow update: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        // Allow self-adding to memberIds array only
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberIds', 'updatedAt']) &&
         request.resource.data.memberIds.hasAll(resource.data.memberIds) &&
         request.resource.data.memberIds.size() == resource.data.memberIds.size() + 1 &&
         request.auth.uid in request.resource.data.memberIds)
      );
      
      // Delete: only owner
      allow delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      
      // Members Subcollection
      match /members/{userId} {
        // Read: if you're a member of this farm (check memberIds of parent farm)
        allow read: if isAuthenticated() && 
          request.auth.uid in get(/databases/$(database)/documents/farms/$(farmId)).data.memberIds;
        
        // Create/Update: 
        // 1. Owner can add/modify any member, OR
        // 2. User can create/update their own member document (invitation acceptance)
        allow create, update: if isAuthenticated() && (
          get(/databases/$(database)/documents/farms/$(farmId)).data.ownerId == request.auth.uid ||
          userId == request.auth.uid
        );
        
        // Delete: only owner can remove members
        allow delete: if isAuthenticated() && 
          get(/databases/$(database)/documents/farms/$(farmId)).data.ownerId == request.auth.uid;
      }
      
      // =========================================================================
      // INVITATIONS SUBCOLLECTION (New Architecture)
      // =========================================================================
      match /invitations/{invitationId} {
        // READ: Farm members can view invitations
        allow read: if isAuthenticated() && 
          request.auth.uid in get(/databases/$(database)/documents/farms/$(farmId)).data.memberIds;
        
        // CREATE: Only farm owner can create invitations
        allow create: if isAuthenticated() && 
          get(/databases/$(database)/documents/farms/$(farmId)).data.ownerId == request.auth.uid &&
          request.resource.data.farmId == farmId &&
          request.resource.data.status == 'pending';
        
        // UPDATE: Accept invitation (matching email) OR manage (owner only)
        allow update: if isAuthenticated() && (
          // Accept invitation - anyone with matching email
          (request.resource.data.status == 'accepted' &&
           resource.data.status == 'pending' &&
           request.auth.token.email.lower() == resource.data.email.lower()) ||
          
          // Manage invitation - only farm owner
          get(/databases/$(database)/documents/farms/$(farmId)).data.ownerId == request.auth.uid
        );
        
        // DELETE: Only farm owner
        allow delete: if isAuthenticated() &&
          get(/databases/$(database)/documents/farms/$(farmId)).data.ownerId == request.auth.uid;
      }
    }
    
    // =========================================================================
    // INVITATION TOKEN LOOKUP (Collection Group Query)
    // =========================================================================
    // Allow public read by token for invitation acceptance flow
    match /{path=**}/invitations/{invitationId} {
      allow read: if resource.data.status == 'pending';
    }
    
    // Animals - accessible only by farm members
    match /animals/{animalId} {
      // Read: must be member of the farm that owns this animal
      allow read: if isAuthenticated() && isFarmMember(resource.data.farmId);
      
      // Create: must be authenticated and farmId must match user's farm
      allow create: if isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        request.resource.data.farmId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.farmId;
      
      // Update: must be member of the farm and farmId cannot be changed
      allow update: if isAuthenticated() && 
        isFarmMember(resource.data.farmId) &&
        request.resource.data.farmId == resource.data.farmId;
      
      // Delete: must be member of the farm
      allow delete: if isAuthenticated() && isFarmMember(resource.data.farmId);
    }
    
    
    // Tasks - accessible only by farm members
    match /tasks/{taskId} {
      allow read: if isAuthenticated() && isFarmMember(resource.data.farmId);
      
      allow create: if isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        request.resource.data.farmId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.farmId;
      
      allow update: if isAuthenticated() && 
        isFarmMember(resource.data.farmId) &&
        request.resource.data.farmId == resource.data.farmId;
      
      allow delete: if isAuthenticated() && isFarmMember(resource.data.farmId);
    }
    
    
    // Inventory - accessible only by farm members
    match /inventory/{itemId} {
      allow read: if isAuthenticated() && isFarmMember(resource.data.farmId);
      
      allow create: if isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        request.resource.data.farmId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.farmId;
      
      allow update: if isAuthenticated() && 
        isFarmMember(resource.data.farmId) &&
        request.resource.data.farmId == resource.data.farmId;
      
      allow delete: if isAuthenticated() && isFarmMember(resource.data.farmId);
    }
    
    
    // Transactions - accessible only by farm members
    match /transactions/{transactionId} {
      allow read: if isAuthenticated() && isFarmMember(resource.data.farmId);
      
      allow create: if isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        request.resource.data.farmId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.farmId;
      
      allow update: if isAuthenticated() && 
        isFarmMember(resource.data.farmId) &&
        request.resource.data.farmId == resource.data.farmId;
      
      allow delete: if isAuthenticated() && isFarmMember(resource.data.farmId);
    }
    
    // Notifications - user specific
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // =========================================================================
    // INVITATIONS - Legacy (Root Collection) - BACKWARD COMPATIBILITY
    // =========================================================================
    // Allow unauthenticated reads so users can validate invitation tokens before registering
    // Only authenticated users can create/update/delete invitations
    match /invitations/{invitationId} {
      allow read: if true; // Public read access for invitation validation
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Reports - generated by Cloud Functions
    match /reports/{reportId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only Cloud Functions can write
    }
    
    // Listings (Marketplace)
    match /listings/{listingId} {
      allow read: if true; // Public
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
        resource.data.sellerId == request.auth.uid;
    }
    
    // Consultations
    match /consultations/{consultationId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated() && 
        resource.data.farmerId == request.auth.uid;
    }
    
    // Veterinarians
    match /veterinarians/{vetId} {
      allow read: if true; // Public
      allow write: if false; // Admin only
    }
  }
}
