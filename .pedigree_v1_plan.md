# Module Pedigree V1 â€” Plan d'ImplÃ©mentation

**Date:** 1er janvier 2026  
**Status:** ğŸ”¨ EN COURS  
**Objectif:** Vue pedigree unifiÃ©e (individuelle/groupÃ©e/globale)

---

## ğŸ“‹ ANALYSE DE L'EXISTANT

### âœ… Ce qui existe dÃ©jÃ  et est CONFORME au PRD:

1. **Moteur de rendu unique** âœ…
   - `FamilyTree.tsx` - Composant SVG unique
   - `PedigreeNode.tsx` - NÅ“ud gÃ©nÃ©rique
   - `ZoomControls.tsx` - ContrÃ´les zoom/pan

2. **Navigation** âœ…
   - Zoom/pan via `useZoomPan` hook
   - Fit-to-view
   - Reset

3. **DonnÃ©es minimales** âœ…
   ```typescript
   Animal { id, name, sireId?, damId? }
   ```

4. **Utilitaires** âœ…
   - `animalsToPedigree.ts` - Conversion donnÃ©es
   - `pedigreeLayout.ts` - Calcul positions
   - `pedigreeValidator.ts` - Validation

### âŒ Ce qui MANQUE selon PRD:

1. **SÃ©lection** âŒ
   - Pas de gestion sÃ©lection actuelle
   - Pas de sÃ©lection multiple
   - Pas de Ctrl/Shift+click

2. **Vue GroupÃ©e** âŒ
   - Seulement vue individuelle (1 rootAnimal)
   - Pas de superposition pedigrees
   - Pas de highlight ancÃªtres communs

3. **Vue Globale** âŒ
   - Pas de vue "tous les animaux"
   - Pas de rÃ©seau complet

4. **Mise en Ã©vidence** âŒ
   - Pas d'attÃ©nuation hors sÃ©lection
   - Pas de highlight ancÃªtres communs

5. **Lecture seule** âš ï¸
   - `AddParentModal` permet Ã©dition
   - Boutons "+" pour ajouter parents
   - âš ï¸ **HORS SCOPE PRD V1**

---

## ğŸ¯ OBJECTIF PRD V1

### Principe clÃ©:
> **UN SEUL moteur** + sÃ©lection = 3 vues automatiques

```
SÃ©lection          â†’  Vue
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Aucune             â†’  Globale (tous animaux)
1 animal           â†’  Individuelle (focus)
N animaux          â†’  GroupÃ©e (superposition)
```

---

## ğŸ—ï¸ ARCHITECTURE PROPOSÃ‰E

### Structure nouvelle:

```
src/components/pedigree/
â”œâ”€â”€ PedigreeViewer.tsx          â† NOUVEAU (Orchestrateur)
â”œâ”€â”€ PedigreeCanvas.tsx          â† REFACTOR de FamilyTree
â”œâ”€â”€ PedigreeNode.tsx            â† KEEP (ajuster highlight)
â”œâ”€â”€ SelectionControls.tsx       â† NOUVEAU
â”œâ”€â”€ ZoomControls.tsx            â† KEEP
â””â”€â”€ hooks/
    â”œâ”€â”€ usePedigreeSelection.ts â† NOUVEAU
    â”œâ”€â”€ usePedigreeLayout.ts    â† NOUVEAU (refactor)
    â””â”€â”€ useZoomPan.ts           â† KEEP

src/utils/
â”œâ”€â”€ pedigreeLayout.ts           â† EXTEND (multi-root)
â”œâ”€â”€ pedigreeGraph.ts            â† NOUVEAU (graph algos)
â””â”€â”€ pedigreeHighlight.ts        â† NOUVEAU (common ancestors)
```

---

## ğŸ“ PLAN D'IMPLÃ‰MENTATION

### Phase 1: Gestion SÃ©lection (Core) âœ… **PRIORITÃ‰ 1**

**Fichiers:**
- `hooks/usePedigreeSelection.ts`

**FonctionnalitÃ©s:**
```typescript
const {
  selection,           // Set<string> - IDs sÃ©lectionnÃ©s
  selectOne,           // (id) => void
  selectMultiple,      // (ids) => void
  toggleSelection,     // (id, multi?) => void
  clearSelection,      // () => void
  selectionMode        // 'none' | 'single' | 'multiple'
} = usePedigreeSelection();
```

**Comportement:**
- Clic simple â†’ sÃ©lection unique
- Ctrl+clic â†’ toggle dans sÃ©lection
- Shift+clic â†’ range select (optionnel V1.1)

---

### Phase 2: Layout Multi-Root âœ… **PRIORITÃ‰ 1**

**Fichiers:**
- `utils/pedigreeLayout.ts` (extend)
- `utils/pedigreeGraph.ts` (nouveau)

**Changements:**

**AVANT (existant):**
```typescript
computeLayout(
  pedigreeData: PedigreeSubject,  // 1 seul root
  config
): PedigreeLayout
```

**APRÃˆS (V1):**
```typescript
computeLayout(
  roots: Animal[],                 // N roots
  allAnimals: Animal[],
  selection: Set<string>,          // Pour filtrage
  config
): PedigreeLayout
```

**Algorithmes Ã  ajouter:**
- Construction graph complet
- DÃ©tection ancÃªtres communs
- Layout multi-arbres (forets)
- Clustering (groupes descendants)

---

### Phase 3: SystÃ¨me de Highlight âœ… **PRIORITÃ‰ 2**

**Fichiers:**
- `utils/pedigreeHighlight.ts`

**Fonctions:**
```typescript
// Trouver ancÃªtres communs entre N animaux
findCommonAncestors(
  animalIds: string[],
  allAnimals: Animal[]
): Set<string>

// Calculer nÅ“uds visibles selon sÃ©lection
getVisibleNodes(
  selection: Set<string>,
  allAnimals: Animal[],
  mode: 'ancestors'|'descendants'|'both'|'all'
): Set<string>

// Calculer niveau d'opacitÃ© par nÅ“ud
getNodeOpacity(
  nodeId: string,
  selection: Set<string>,
  commonAncestors: Set<string>,
  visibleNodes: Set<string>
): number // 0.3 - 1.0
```

**RÃ¨gles visuelles:**
```
Ã‰tat                    Opacity    Stroke    Fill
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SÃ©lectionnÃ©             1.0        Bold      Normal
AncÃªtre commun          1.0        Dashed    Yellow
Parent/Enfant direct    0.9        Normal    Normal
Visible indirect        0.6        Thin      Normal
Hors sÃ©lection          0.3        Thin      Gray
```

---

### Phase 4: Refactor PedigreeCanvas âœ… **PRIORITÃ‰ 2**

**Fichiers:**
- `PedigreeCanvas.tsx` (refactor de `FamilyTree.tsx`)

**Props:**
```typescript
interface PedigreeCanvasProps {
  animals: Animal[];
  selection: Set<string>;
  onNodeClick: (id: string, multi: boolean) => void;
  readOnly?: boolean;              // true pour V1
  showAddButtons?: boolean;        // false pour V1
}
```

**Changements:**
1. Accepter liste d'animaux au lieu de 1 root
2. Utiliser `selection` pour highlight
3. Calculer layout selon sÃ©lection
4. Appliquer opacitÃ©s
5. DÃ©sactiver Ã©dition si `readOnly`

---

### Phase 5: Orchestrateur PedigreeViewer âœ… **PRIORITÃ‰ 1**

**Fichiers:**
- `PedigreeViewer.tsx` (nouveau)

**ResponsabilitÃ©s:**
- Charger tous les animaux
- GÃ©rer Ã©tat sÃ©lection
- Switcher entre vues automatiquement
- Passer props Ã  PedigreeCanvas

```typescript
export const PedigreeViewer: React.FC = () => {
  const { animals } = useAnimals();
  const { selection, selectOne, toggleSelection, clearSelection } = 
    usePedigreeSelection();
  
  // DÃ©terminer mode selon sÃ©lection
  const viewMode = selection.size === 0 ? 'global' :
                   selection.size === 1 ? 'individual' :
                   'grouped';
  
  // Calculer highlight
  const commonAncestors = useMemo(() => 
    findCommonAncestors([...selection], animals),
    [selection, animals]
  );
  
  return (
    <div>
      {/* Toolbar sÃ©lection */}
      <SelectionControls 
        selection={selection}
        viewMode={viewMode}
        onClear={clearSelection}
      />
      
      {/* Canvas unique */}
      <PedigreeCanvas
        animals={animals}
        selection={selection}
        commonAncestors={commonAncestors}
        onNodeClick={(id, multi) => 
          multi ? toggleSelection(id) : selectOne(id)
        }
        readOnly={true}
      />
    </div>
  );
};
```

---

### Phase 6: ContrÃ´les & UI âœ… **PRIORITÃ‰ 3**

**Fichiers:**
- `SelectionControls.tsx`

**Affichage:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pedigree â€¢ Aucune sÃ©lection   [Tout]   â”‚ â† Global
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Pedigree â€¢ Dieureuf                     â”‚ â† Individual
â”‚   â†³ 2 parents, 3 descendants  [Ã—]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Pedigree â€¢ 5 animaux sÃ©lectionnÃ©s [Ã—]  â”‚ â† Grouped
â”‚   â†³ 2 ancÃªtres communs                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š MODES DE VUE â€” COMPORTEMENTS

### Vue Globale (selection.size === 0)

**Affichage:**
- Tous les animaux du troupeau
- Tous les liens parentâ†’enfant
- Pas de focus particulier
- Layout: forÃªt complÃ¨te

**Actions:**
- Clic sur nÅ“ud â†’ Vue individuelle
- Ctrl+clic multiple â†’ Vue groupÃ©e

---

### Vue Individuelle (selection.size === 1)

**Affichage:**
- Animal sÃ©lectionnÃ©: opacity 1.0, stroke bold
- Parents directs: opacity 0.9
- Grands-parents: opacity 0.7
- Descendants: opacity 0.9
- Reste: opacity 0.3

**Layout:**
- CentrÃ© sur sÃ©lectionnÃ©
- N gÃ©nÃ©rations ascendantes (config)
- N gÃ©nÃ©rations descendantes (config)

**Actions:**
- Clic autre nÅ“ud â†’ Switche sÃ©lection
- Ctrl+clic â†’ Ajoute Ã  sÃ©lection (â†’ groupÃ©e)

---

### Vue GroupÃ©e (selection.size > 1)

**Affichage:**
- Animaux sÃ©lectionnÃ©s: opacity 1.0
- AncÃªtres communs: opacity 1.0, fill yellow
- Tous ascendants: opacity 0.7
- Tout le reste: opacity 0.3

**Layout:**
- Fit sur bbox sÃ©lection + ancÃªtres
- Liens entre sÃ©lectionnÃ©s mis en valeur

**Actions:**
- Clic nÅ“ud non-select â†’ Ajoute
- Clic nÅ“ud sÃ©lectionnÃ© â†’ Retire
- Clic vide â†’ Clear (â†’ globale)

---

## ğŸš€ ORDRE D'IMPLÃ‰MENTATION

### Sprint 1: Core Foundation (2-3h)
1. âœ… CrÃ©er `usePedigreeSelection`
2. âœ… Extend `pedigreeLayout` pour multi-root
3. âœ… CrÃ©er `pedigreeGraph` utils

### Sprint 2: Highlight System (2h)
4. âœ… CrÃ©er `pedigreeHighlight` utils
5. âœ… Tester algos ancÃªtres communs

### Sprint 3: Canvas Refactor (3h)
6. âœ… Refactor `FamilyTree` â†’ `PedigreeCanvas`
7. âœ… IntÃ©grer systÃ¨me highlight
8. âœ… GÃ©rer clics avec sÃ©lection

### Sprint 4: Orchestration (2h)
9. âœ… CrÃ©er `PedigreeViewer`
10. âœ… CrÃ©er `SelectionControls`
11. âœ… Connecter tout ensemble

### Sprint 5: Polish (1h)
12. âœ… Transitions smooth
13. âœ… UX feedback (sÃ©lection visuelle)
14. âœ… Tests utilisateur

**Temps total estimÃ©: ~10h**

---

## ğŸ¨ DESIGN DECISIONS

### Layout Algorithm

**StratÃ©gie:**
- Dagre.js pour layout automatique OU
- Custom tree layout par gÃ©nÃ©ration

**Contraintes:**
- Pas de croisement de liens si possible
- GÃ©nÃ©rations alignÃ©es horizontalement
- Espacement uniforme

### Gestion Grands Graphes

**Performance:**
- Virtualization si > 500 nÅ“uds
- Lazy loading branches
- SVG clipping

**UX:**
- Minimap (optionnel V1.1)
- Search bar (optionnel V1.1)

---

## âŒ HORS SCOPE V1 (Explicite)

Ces fonctionnalitÃ©s sont **RETIRÃ‰ES** de l'implementation actuelle:

1. âŒ Boutons "+" ajout parents
2. âŒ `AddParentModal`
3. âŒ Ã‰dition quelconque
4. âŒ Scores/consanguinitÃ©/reproduction
5. âŒ Rectangle de sÃ©lection
6. âŒ Minimap
7. âŒ Search

â†’ Module **LECTURE SEULE** pure

---

## ğŸ“¦ DELIVERABLES

### Code:
- `PedigreeViewer.tsx` - Orchestrateur
- `PedigreeCanvas.tsx` - Moteur rendu
- `usePedigreeSelection.ts` - Hook sÃ©lection
- `pedigreeGraph.ts` - Algos graph
- `pedigreeHighlight.ts` - Logique highlight
- `SelectionControls.tsx` - UI contrÃ´les

### Documentation:
- Guide utilisateur (3 vues)
- Guide dÃ©veloppeur (extend module)

### Tests:
- SÃ©lection simple/multiple
- AncÃªtres communs (cas complexes)
- Performance (1000+ animaux)

---

## ğŸ¯ SUCCESS CRITERIA

âœ… **Must Have:**
1. 1 seul composant de rendu
2. 3 vues fonctionnelles (global/individual/grouped)
3. SÃ©lection intuitive (clic simple/Ctrl+clic)
4. Highlight ancÃªtres communs
5. Zoom/pan fluide
6. Lecture seule (pas d'Ã©dition)

âœ… **Nice to Have:**
7. Transitions smooth entre vues
8. Performance < 100ms layout (500 animaux)
9. Minimap
10. Search

---

*Le module Pedigree V1 sera un visualisateur pur, simple et performant selon le PRD.*
